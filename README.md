<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# kryptografpersister

```go
import "github.com/sa6mwa/kryptografpersister"
```

kryptografpersister is an API server persisting json kryptograf messages \(map\[string\]\[\]byte\) or any other json key\-value pair in the format \{"key\_string":"base64\_encoded\_byte\_slice"\}.

Install:

```
GOBIN=$HOME/bin go install github.com/sa6mwa/kryptografpersister@latest
```

Usage:

```
$ bin/kryptografpersister -h
Usage of bin/kryptografpersister:
	-addr string
		Address to bind the Persister http server to (default ":11185")
	-db string
		AnyStore DB file used as backend for the storage API (default "kryptografpersister.db")
	-encryption-key-env string
		Environment variable to retrieve the encryption key used to
		load and store data in the AnyStoreDB (default
		"PERSISTER_ENCRYPTION_KEY")
	-protocol string
		Network protocol to listen on (default "tcp4")

$ bin/kryptografpersister -db
$ bin/kryptografpersister -db ~/test.db
2023/09/27 21:46:14 server.go:99: Successfully opened persistence file "/home/sa6mwa/test.db"
2023/09/27 21:46:14 server.go:110: Persistence file "/home/sa6mwa/test.db" contains 0 keys
2023/09/27 21:46:14 server.go:248: Serving tcp4 http requests on 0.0.0.0:11185
```

## Index

- [Constants](<#constants>)


## Constants

<a name="DefaultAddress"></a>

```go
const (
    DefaultAddress          string = ":11185"
    DefaultProtocol         string = "tcp4"
    DefaultEncryptionKey    string = "Z6pT9Iw+YTiRtyIuNjn3q0vwc6BSZpPFpZn7sH606xU"
    DefaultEncryptionKeyEnv string = "PERSISTER_ENCRYPTION_KEY"
    DefaultAnyStoreDBFile   string = "kryptografpersister.db"
)
```

# server

```go
import "github.com/sa6mwa/kryptografpersister/pkg/server"
```

## Index

- [Constants](<#constants>)
- [func ListenAndServe\(customListener net.Listener, srv \*http.Server\) error](<#ListenAndServe>)
- [func LoggingMiddleware\(l \*log.Logger, next http.Handler\) http.Handler](<#LoggingMiddleware>)
- [func PlainStart\(protocol, address, dbFile, encryptionKey string\) error](<#PlainStart>)
- [func RandomStamp\(tm ...time.Time\) string](<#RandomStamp>)
- [func Start\(proto, addr, dbFile, encryptionKey string, l \*log.Logger, srv \*http.Server\) \(chan error, chan struct\{\}, \*string, error\)](<#Start>)
- [func ToJson\(v any\) \[\]byte](<#ToJson>)
- [type Data](<#Data>)
  - [func StoreJsonKV\(a anystore.AnyStore, stream io.Reader\) \(\[\]Data, error\)](<#StoreJsonKV>)
- [type Msg](<#Msg>)


## Constants

<a name="ContentTypeHeader"></a>

```go
const (
    ContentTypeHeader string = "Content-Type"
    AcceptHeader      string = "Accept"
    ApplicationJSON   string = "application/json;charset=utf-8"
)
```

<a name="ListenAndServe"></a>
## func [ListenAndServe](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L364>)

```go
func ListenAndServe(customListener net.Listener, srv *http.Server) error
```



<a name="LoggingMiddleware"></a>
## func [LoggingMiddleware](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L53>)

```go
func LoggingMiddleware(l *log.Logger, next http.Handler) http.Handler
```

LoggingMiddleware is a logging http.Handler.

<a name="PlainStart"></a>
## func [PlainStart](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L262>)

```go
func PlainStart(protocol, address, dbFile, encryptionKey string) error
```

PlainStart is a simple wrapper for Start, blocking until the HTTP server is terminated or on error.

<a name="RandomStamp"></a>
## func [RandomStamp](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L294>)

```go
func RandomStamp(tm ...time.Time) string
```

RandomStamp returns time.Now\(\).UTC\(\) as time.Format "20060102T150405.999999999\_\{19 character random int63\}". If one tm is provided in the optional variadic argument, the first time.Time from the tm slice is used instead of time.Now\(\).UTC\(\). Intended usage of this function is for creating keys for a KV map\[string\]\[\]byte pair sent as a json stream.

<a name="Start"></a>
## func [Start](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L85>)

```go
func Start(proto, addr, dbFile, encryptionKey string, l *log.Logger, srv *http.Server) (chan error, chan struct{}, *string, error)
```

Start starts the kryptografpersister HTTP server, serving the API on proto at addr using AnyStoreDB persistence file dbFile with encryptionKey. Logging is done through l \(if nil, log.Default\(\) will be used\). srv can be used to initialize timeouts, etc \(but Handler and Addr will be overwritten\). Start returns an error channel that will return nil or error when server is closed, a terminator channel that, when closed, will terminate the http server. The actual listen address from net.Listen is returned as a string pointer. Usage example:

```
returnCh, terminator, addr, err := server.Start("tcp", ":0", dbFile, "lhOAmgGdrFnfnsysiFMTwTZ227LxlFemjuRL72yPkRo", log.Default(), nil)
if err != nil {
	log.Fatal(err)
}
//defer close(terminator)
defer close(returnCh)
log.Println("Reduntant log message, listening to %s", *addr)
go func() {
	time.Sleep(5 * time.Second)
	close(terminator)
}()
err = <-returnCh
if err != nil {
	log.Fatal(err)
}
```

<a name="ToJson"></a>
## func [ToJson](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L280>)

```go
func ToJson(v any) []byte
```



<a name="Data"></a>
## type [Data](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L31-L34>)

Data is the type of each incoming json map\[string\]\[\]byte \(\{"key":"ciphertext"\}\). Each Data is stored under a unique key in the anystore.

```go
type Data struct {
    Key        string `json:"key"`
    Ciphertext []byte `json:"ciphertext"`
}
```

<a name="StoreJsonKV"></a>
### func [StoreJsonKV](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L313>)

```go
func StoreJsonKV(a anystore.AnyStore, stream io.Reader) ([]Data, error)
```

StoreJsonKV stores a \{"key":"base64\_ciphertext"\} json object from stream into the a AnyStore atomically with a unique random key \(as AnyStore key\) and ensures key does not exist before storing, all done in a Run transaction. The incoming KV pair is stored as a server.Data object. In case there is any error in the stream, all already stored key\-value pairs are deleted \(rolled back\) and the function returns an error \(i.e operation is atomic\). If StoreJsonKV does not return an error, all KV pairs in the stream were successfully persisted to the AnyStore. Returns a Data slice with all persisted objects or error.

<a name="Msg"></a>
## type [Msg](<https://github.com/sa6mwa/kryptografpersister/blob/main/pkg/server/server.go#L276-L278>)



```go
type Msg struct {
    Msg string `json:"message"`
}
```

# crand

```go
import "github.com/sa6mwa/kryptografpersister/internal/pkg/crand"
```

## Index

- [func ExpFloat64\(\) float64](<#ExpFloat64>)
- [func Float32\(\) float32](<#Float32>)
- [func Float64\(\) float64](<#Float64>)
- [func Int\(\) int](<#Int>)
- [func Int31\(\) int32](<#Int31>)
- [func Int31n\(n int32\) int32](<#Int31n>)
- [func Int63\(\) int64](<#Int63>)
- [func Int63n\(n int64\) int64](<#Int63n>)
- [func Intn\(n int\) int](<#Intn>)
- [func NormFloat64\(\) float64](<#NormFloat64>)
- [func Perm\(n int\) \[\]int](<#Perm>)
- [func Read\(p \[\]byte\) \(n int, err error\)](<#Read>)
- [func ReadRunes\(p \[\]rune\) \(n int, err error\)](<#ReadRunes>)
- [func Seed\(seed int64\)](<#Seed>)
- [func Shuffle\(n int, swap func\(i, j int\)\)](<#Shuffle>)
- [func Uint32\(\) uint32](<#Uint32>)
- [func Uint64\(\) uint64](<#Uint64>)


<a name="ExpFloat64"></a>
## func [ExpFloat64](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L76>)

```go
func ExpFloat64() float64
```



<a name="Float32"></a>
## func [Float32](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L70>)

```go
func Float32() float32
```



<a name="Float64"></a>
## func [Float64](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L69>)

```go
func Float64() float64
```



<a name="Int"></a>
## func [Int](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L65>)

```go
func Int() int
```



<a name="Int31"></a>
## func [Int31](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L64>)

```go
func Int31() int32
```



<a name="Int31n"></a>
## func [Int31n](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L67>)

```go
func Int31n(n int32) int32
```



<a name="Int63"></a>
## func [Int63](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L61>)

```go
func Int63() int64
```



<a name="Int63n"></a>
## func [Int63n](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L66>)

```go
func Int63n(n int64) int64
```



<a name="Intn"></a>
## func [Intn](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L68>)

```go
func Intn(n int) int
```



<a name="NormFloat64"></a>
## func [NormFloat64](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L75>)

```go
func NormFloat64() float64
```



<a name="Perm"></a>
## func [Perm](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L71>)

```go
func Perm(n int) []int
```



<a name="Read"></a>
## func [Read](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L73>)

```go
func Read(p []byte) (n int, err error)
```



<a name="ReadRunes"></a>
## func [ReadRunes](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L74>)

```go
func ReadRunes(p []rune) (n int, err error)
```



<a name="Seed"></a>
## func [Seed](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L60>)

```go
func Seed(seed int64)
```

These functions are frontends to math/rand...

<a name="Shuffle"></a>
## func [Shuffle](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L72>)

```go
func Shuffle(n int, swap func(i, j int))
```



<a name="Uint32"></a>
## func [Uint32](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L62>)

```go
func Uint32() uint32
```



<a name="Uint64"></a>
## func [Uint64](<https://github.com/sa6mwa/kryptografpersister/blob/main/internal/pkg/crand/crand.go#L63>)

```go
func Uint64() uint64
```



Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
